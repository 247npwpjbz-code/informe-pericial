<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Informe Pericial – Editor Web</title>

<!-- Librerías -->
<script src="https://cdn.jsdelivr.net/npm/tinymce@6/tinymce.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
/* === AJUSTE GENERAL === */
body {
    font-family: Calibri, Arial, sans-serif;
    margin-left: 215px; /* Barra lateral 200px + margen 15px */
    margin-top: 20px;
    background: #f8f9fb;
}

/* === BARRA LATERAL IZQUIERDA === */
#barra-lateral {
    position: fixed;
    top: 0;
    left: 0;
    width: 180px;
    height: 100vh;
    background: #0A2A43;
    color: white;
    padding: 12px;
    overflow-y: auto;
    box-shadow: 3px 0 6px rgba(0,0,0,0.3);
    z-index: 9999;
}

#barra-lateral h3 {
    margin-top: 0;
    font-size: 16pt;
    text-align: center;
    margin-bottom: 20px;
}

#barra-lateral label {
    font-size: 11pt;
    margin-top: 10px;
    display: block;
}

#barra-lateral select {
    width: 100%;
    padding: 6px;
    margin-top: 5px;
    margin-bottom: 10px;
    border-radius: 4px;
}

#barra-lateral button {
    width: 100%;
    background: #1a4d6c;
    margin-bottom: 20px;
    padding: 8px;
    border: none;
    color: white;
    border-radius: 4px;
    cursor: pointer;
}

/* === BOTONES GENERALES === */
button {
    padding: 8px 14px;
    font-size: 13px;
    cursor: pointer;
    margin: 6px 6px 6px 0;
    border-radius: 4px;
    border: none;
    background: #0A2A43;
    color: white;
}

/* === ENCABEZADO === */
.encabezado {
    border: 3px solid #0A2A43;
    padding: 20px;
    margin-bottom: 25px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.encabezado .titulo {
    text-align: center;
    width: 100%;
}

.encabezado h1 {
    font-size: 20pt;
    margin: 0;
    color: #0A2A43;
    font-weight: bold;
}

.encabezado h2 {
    font-size: 13pt;
    margin: 5px 0 0 0;
    color: #333;
}

.sello {
    width: 160px;
    height: 160px;
    border: 2px dashed #0A2A43;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 11pt;
    color: #0A2A43;
    font-weight: bold;
}

/* === CROQUIS === */
.espacio-croquis {
    border: 2px dashed #0A2A43;
    padding: 20px;
    text-align: center;
    margin: 20px 0;
    font-size: 11pt;
    color: #0A2A43;
    font-weight: bold;
}

/* === TABLAS === */
.tabla-tecnica {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10pt;
    margin-bottom: 20pt;
}

.tabla-tecnica th {
    background-color: #0A2A43;
    color: white;
    padding: 6pt;
    border: 1px solid #ccc;
}

.tabla-tecnica td {
    padding: 6pt;
    border: 1px solid #ccc;
}

/* === PIE === */
.pie-pagina {
    text-align: center;
    font-size: 9pt;
    color: #666;
    margin-top: 40px;
}

.pie-logo {
    text-align: right;
    margin-top: 10px;
}
</style>
</head>

<body>

<!-- ============================
     BARRA LATERAL IZQUIERDA
=============================== -->
<div id="barra-lateral">
    <h3>Menús del informe</h3>

    <label>Tipo de informe</label>
    <select id="menuInforme">
        <option value="">Seleccione…</option>
        <option>Informe pericial</option>
        <option>Ampliación de informe</option>
        <option>Ratificación</option>
        <option>Contrapericial</option>
        <option>Informe técnico</option>
    </select>
    <button onclick="insertarDesdeMenu('menuInforme')">Insertar</button>

    <label>Tipo de accidente</label>
    <select id="menuAccidente">
        <option value="">Seleccione…</option>
        <option>Colisión fronto–frontal</option>
        <option>Colisión fronto–lateral</option>
        <option>Colisión por alcance</option>
        <option>Atropello</option>
        <option>Salida de vía</option>
        <option>Vuelco</option>
        <option>Colisión múltiple</option>
        <option>Otro</option>
    </select>
    <button onclick="insertarDesdeMenu('menuAccidente')">Insertar</button>

    <label>Vehículo A – Tipo</label>
    <select id="menuVehiculoA">
        <option value="">Seleccione…</option>
        <option>Turismo</option>
        <option>Motocicleta</option>
        <option>Furgón</option>
        <option>Camión</option>
        <option>Autobús</option>
        <option>Bicicleta</option>
        <option>Patinete</option>
        <option>Otro</option>
    </select>
    <button onclick="insertarDesdeMenu('menuVehiculoA')">Insertar</button>

    <label>Vehículo B – Tipo</label>
    <select id="menuVehiculoB">
        <option value="">Seleccione…</option>
        <option>Turismo</option>
        <option>Motocicleta</option>
        <option>Furgón</option>
        <option>Camión</option>
        <option>Autobús</option>
        <option>Bicicleta</option>
        <option>Patinete</option>
        <option>Otro</option>
    </select>
    <button onclick="insertarDesdeMenu('menuVehiculoB')">Insertar</button>

    <label>Condiciones de la vía</label>
    <select id="menuVia">
        <option value="">Seleccione…</option>
        <option>Recta</option>
        <option>Curva</option>
        <option>Intersección</option>
        <option>Glorieta</option>
        <option>Cambio de rasante</option>
        <option>Túnel</option>
        <option>Incorporación</option>
        <option>Otro</option>
    </select>
    <button onclick="insertarDesdeMenu('menuVia')">Insertar</button>

    <label>Estado del pavimento</label>
    <select id="menuPavimento">
        <option value="">Seleccione…</option>
        <option>Seco</option>
        <option>Húmedo</option>
        <option>Mojado</option>
        <option>Aceite</option>
        <option>Grava</option>
        <option>Hielo</option>
        <option>Otro</option>
    </select>
    <button onclick="insertarDesdeMenu('menuPavimento')">Insertar</button>

    <label>Visibilidad</label>
    <select id="menuVisibilidad">
        <option value="">Seleccione…</option>
        <option>Buena</option>
        <option>Media</option>
        <option>Mala</option>
        <option>Noche</option>
        <option>Lluvia</option>
        <option>Niebla</option>
        <option>Deslumbramiento</option>
    </select>
    <button onclick="insertarDesdeMenu('menuVisibilidad')">Insertar</button>

    <label>Señalización que afecta al accidente</label>
    <select id="menuSenalizacion">
        <option value="">Seleccione…</option>
        <option>Señalización Horizontal</option>
        <option>Señalización Vertical de Peligro</option>
        <option>Señalización Vertical Informativa</option>
        <option>Señalización Lumínica</option>
        <option>Señalización por Agentes</option>
        <option>Balizamiento</option>
        <option>Obras</option>
        <option>Otros</option>
    </select>
    <button onclick="insertarDesdeMenu('menuSenalizacion')">Insertar</button>

    <button onclick="geolocalizar()">Geolocalizar in situ</button>
</div>

<!-- ============================
     ENCABEZADO
=============================== -->
<div class="encabezado">
    <div class="titulo">
        <h1>INFORME PERICIAL DE INVESTIGACIÓN</h1>
        <h1>Y RECONSTRUCCIÓN DE ACCIDENTE DE TRÁFICO</h1>
        <h2>Perito Judicial: Manuel Pedro Martín Suazo</h2>
    </div>

    <div style="display:flex; flex-direction:column; align-items:center; margin-left:20px;">
        <div class="sello" id="selloLogo">LOGOTIPO</div>
        <button onclick="document.getElementById('selectorLogo').click()" style="margin-top:10px;">
            <i class="fa-solid fa-image"></i> Cargar logo
        </button>
        <input type="file" id="selectorLogo" accept="image/*" style="display:none;" onchange="insertarLogo()">
    </div>
</div>

<button onclick="abrirDireccion()">
<button onclick="abrirCoordenadas()">
<button onclick="geolocalizar()">


<!-- ============================
     EDITOR
=============================== -->
<textarea id="editor">

<p><b>Referencia del informe:</b> {{REFERENCIA}}</p>

<p><b>Perito Judicial:</b> Manuel Pedro Martín Suazo</p>
<p><b>Localidad:</b> Llucmajor, Illes Balears</p>
<p><b>Fecha:</b> <span contenteditable="true">__/__/____</span></p>
<p><b>N.º de expediente:</b> <span contenteditable="true"></span></p>

<hr>

<h1>Objeto del informe</h1>
<p contenteditable="true">Descripción del propósito del informe pericial solicitado.</p>

<h1>Documentación analizada</h1>
<ul>
    <li><span contenteditable="true">Atestado policial</span></li>
    <li><span contenteditable="true">Declaraciones de implicados</span></li>
    <li><span contenteditable="true">Informes médicos</span></li>
    <li><span contenteditable="true">Reportaje fotográfico</span></li>
</ul>

<h1>Metodología empleada</h1>
<p contenteditable="true">
Se han aplicado técnicas de investigación y reconstrucción de accidentes de tráfico basadas en normativa UNE, análisis de huellas, dinámica vehicular, estudio de daños y correlación mecánica.
</p>

<h1>Descripción del lugar del accidente</h1>

<h2>Dirección del accidente</h2>
<p>Dirección: <span class="direccion-accidente" contenteditable="true">Calle Ejemplo 123, Palma</span></p>

<h2>Coordenadas del accidente</h2>
<p>Latitud: <span class="latitud" contenteditable="true">39.569600</span></p>
<p>Longitud: <span class="longitud" contenteditable="true">2.650200</span></p>

<h2>Tipo de vía</h2>
<p contenteditable="true"></p>

<h2>Trazado</h2>
<p contenteditable="true"></p>

<h2>Señalización</h2>
<p contenteditable="true"></p>

<h2>Visibilidad</h2>
<p contenteditable="true"></p>

<h2>Estado del pavimento</h2>
<p contenteditable="true"></p>

<h2>Condiciones ambientales</h2>
<p contenteditable="true"></p>

<h1>Vehículos implicados</h1>

<h2>Vehículo A</h2>

<table class="tabla-tecnica">
<tr><th>Parámetro</th><th>Valor</th><th>Unidad</th><th>Observaciones</th></tr>
<tr><td>Marca</td><td contenteditable="true"></td><td>—</td><td contenteditable="true"></td></tr>
<tr><td>Modelo</td><td contenteditable="true"></td><td>—</td><td contenteditable="true"></td></tr>
<tr><td>Matrícula</td><td contenteditable="true"></td><td>—</td><td contenteditable="true"></td></tr>
<tr><td>Daños</td><td contenteditable="true"></td><td>—</td><td contenteditable="true"></td></tr>
<tr><td>Posición final</td><td contenteditable="true"></td><td>—</td><td contenteditable="true"></td></tr>
</table>

<h2>Vehículo B</h2>
<p contenteditable="true">(Añadir tabla si procede)</p>

<h1>Análisis técnico del siniestro</h1>

<p contenteditable="true">
Descripción detallada del análisis técnico, dinámica del accidente, correlación de daños, estudio de huellas, velocidades estimadas, trayectoria de vehículos, etc.
</p>

<div class="espacio-croquis">
    <p><b>ESPACIO PARA CROQUIS / FOTOGRAFÍAS</b></p>
    <input type="file" id="selectorImagen6" accept="image/*" onchange="insertarImagenEnEditor('selectorImagen6')" style="margin-top:10px;">
</div>

<h1>Reconstrucción del accidente</h1>

<p contenteditable="true">
Descripción detallada de la reconstrucción del accidente, fases del siniestro, maniobras previas, punto de conflicto, posiciones finales, etc.
</p>

<div class="espacio-croquis">ESPACIO PARA CROQUIS / FOTOGRAFÍAS</div>

<h1>Conclusiones</h1>
<ol>
    <li><span contenteditable="true">Conclusión 1</span></li>
    <li><span contenteditable="true">Conclusión 2</span></li>
    <li><span contenteditable="true">Conclusión 3</span></li>
</ol>

<h1>Anexos</h1>

<div class="espacio-croquis">
    <p><b>ESPACIO PARA ANEXOS / FOTOGRAFÍAS / DOCUMENTACIÓN</b></p>
    <input type="file" id="selectorImagen9" accept="image/*" onchange="insertarImagenEnEditor('selectorImagen9')" style="margin-top:10px;">
</div>

</textarea>

<!-- ============================
     FIRMA BIOMÉTRICA
=============================== -->
<h2>Firma biométrica</h2>

<div id="panelFirma" style="border:1px solid #ccc; padding:15px; margin-top:10px;">
    <p><b>Firme aquí con el dedo, Apple Pencil o ratón:</b></p>

    <canvas id="canvasFirma" width="500" height="200" 
        style="border:1px solid #000; touch-action:none; pointer-events:auto;">
    </canvas>

    <div style="margin-top:10px;">
        <button onclick="limpiarFirma()">Limpiar</button>
        <button onclick="guardarFirma()">Guardar firma</button>
        <button onclick="insertarFirmaEnInforme()">Insertar firma en el informe</button>
    </div>
</div>

<br><br>

<p>______________________________<br>
<b>Manuel Pedro Martín Suazo</b><br>
Perito Judicial nº 03478</p>

<!-- ============================
     PIE DE PÁGINA
=============================== -->
<div class="pie-pagina">
    <p>Referencia: <span id="refPiePagina"></span></p>
    <p>Generado el: <span id="fechaPiePagina"></span></p>

    <div class="pie-logo">
        <img src="img/logo-aspejure.png" style="width:140px;">
    </div>
</div>

<!-- ============================
     SISTEMA DE REFERENCIA
=============================== -->
<script>
function generarReferencia() {
    const año = new Date().getFullYear();
    const clave = "contadorInformes_" + año;
    let contador = localStorage.getItem(clave);
    if (!contador) contador = 0;
    contador++;
    localStorage.setItem(clave, contador);
    const numero = String(contador).padStart(4, "0");
    return `INF-${año}-${numero}`;
}

let referenciaActual = generarReferencia();
document.getElementById("refPiePagina").innerText = referenciaActual;
document.getElementById("fechaPiePagina").innerText = new Date().toLocaleString();

// Sustituir {{REFERENCIA}} dentro del editor cuando TinyMCE esté listo
document.addEventListener("DOMContentLoaded", () => {
    setTimeout(() => {
        const ed = tinymce.get("editor");
        if (ed) {
            let contenido = ed.getContent();
            contenido = contenido.replace("{{REFERENCIA}}", referenciaActual);
            ed.setContent(contenido);
        }
    }, 800);
});
</script>

<!-- ============================
     EXPORTAR PDF
=============================== -->
<script>
function exportarPDF() {
    const editor = tinymce.get('editor');
    const contenido = editor.getContent();
    const temp = document.createElement('div');
    temp.innerHTML = contenido;
    temp.style.padding = '20px';
    document.body.appendChild(temp);
    const opt = {
        margin: 10,
        filename: referenciaActual + '.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().set(opt).from(temp).save().then(() => {
        document.body.removeChild(temp);
    });
}
</script>

<!-- ============================
     INSERTAR IMÁGENES
=============================== -->
<script>
function insertarImagenEnEditor(idInput) {
    const input = document.getElementById(idInput);
    const archivo = input.files[0];
    if (!archivo) return;
    const lector = new FileReader();
    lector.onload = function(e) {
        const editor = tinymce.get('editor');
        editor.insertContent(`<img src="${e.target.result}" style="max-width:100%; margin:10px 0;">`);
    };
    lector.readAsDataURL(archivo);
}
</script>

<!-- ============================
     LOGO PERSONAL
=============================== -->
<script>
function insertarLogo() {
    const input = document.getElementById('selectorLogo');
    const archivo = input.files[0];
    if (!archivo) return;
    const lector = new FileReader();
    lector.onload = function(e) {
        const sello = document.getElementById('selloLogo');
        sello.innerHTML = `<img src="${e.target.result}" style="max-width:100%; max-height:100%; object-fit:contain;">`;
    };
    lector.readAsDataURL(archivo);
}
</script>

<!-- ============================
     FIRMA BIOMÉTRICA
=============================== -->
<script>
let canvas = document.getElementById("canvasFirma");
let ctx = canvas.getContext("2d");
let dibujando = false;

canvas.addEventListener("pointerdown", e => {
    dibujando = true;
    ctx.beginPath();
    ctx.moveTo(e.offsetX, e.offsetY);
});
canvas.addEventListener("pointermove", e => {
    if (!dibujando) return;
    ctx.lineTo(e.offsetX, e.offsetY);
    ctx.stroke();
});
canvas.addEventListener("pointerup", () => dibujando = false);
canvas.addEventListener("pointerleave", () => dibujando = false);

function limpiarFirma() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}
function guardarFirma() {
    const dataURL = canvas.toDataURL("image/png");
    localStorage.setItem("firmaGuardada", dataURL);
    alert("Firma guardada correctamente.");
}
function insertarFirmaEnInforme() {
    const firma = localStorage.getItem("firmaGuardada");
    if (!firma) {
        alert("No hay firma guardada.");
        return;
    }
    const editor = tinymce.get("editor");
    editor.insertContent(
        `<p><b>Firma del perito:</b></p>
         <img src="${firma}" style="max-width:300px; border:1px solid #000;">`
    );
}
</script>

<!-- ============================
     MENÚS DESPLEGABLES → INSERTAR EN EDITOR
=============================== -->
<script>
function insertarDesdeMenu(idMenu) {
    const valor = document.getElementById(idMenu).value;
    if (!valor) return;

    const editor = tinymce.get("editor");
    editor.insertContent(`<p><b>${valor}</b></p>`);
}
</script>

<!-- ============================
     GEOLOCALIZACIÓN Y GOOGLE MAPS
=============================== -->
<script>
function geolocalizar() {
    if (!navigator.geolocation) {
        alert("La geolocalización no está soportada en este dispositivo.");
        return;
    }

    navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = pos.coords.latitude.toFixed(6);
        const lon = pos.coords.longitude.toFixed(6);

        const latSpan = document.querySelector(".latitud");
        const lonSpan = document.querySelector(".longitud");
        const dirSpan = document.querySelector(".direccion-accidente");

        if (latSpan) latSpan.innerText = lat;
        if (lonSpan) lonSpan.innerText = lon;

        try {
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`;
            const resp = await fetch(url);
            const data = await resp.json();

            if (data && data.display_name && dirSpan) {
                dirSpan.innerText = data.display_name;
            } else if (dirSpan) {
                dirSpan.innerText = "Dirección no disponible";
            }
        } catch (e) {
            if (dirSpan) dirSpan.innerText = "Dirección no disponible";
        }

        alert("Geolocalización insertada correctamente.");
    },
    (err) => {
        alert("No se pudo obtener la ubicación.");
    });
}

function abrirDireccion() {
    const dirSpan = document.querySelector(".direccion-accidente");
    const direccion = dirSpan ? dirSpan.innerText.trim() : "";
    if (!direccion) {
        alert("No hay dirección disponible.");
        return;
    }
    const url = "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(direccion);
    window.open(url, "_blank");
}

function abrirCoordenadas() {
    const latSpan = document.querySelector(".latitud");
    const lonSpan = document.querySelector(".longitud");
    const lat = latSpan ? latSpan.innerText.trim() : "";
    const lon = lonSpan ? lonSpan.innerText.trim() : "";

    if (!lat || !lon) {
        alert("No hay coordenadas disponibles.");
        return;
    }

    const url = `https://www.google.com/maps?q=${lat},${lon}`;
    window.open(url, "_blank");
}
</script>

<!-- ============================
     INICIALIZACIÓN TINYMCE
=============================== -->
<script>
tinymce.init({
    selector: '#editor',
    height: 1200,
    plugins: 'lists table image code',
    toolbar: 'undo redo | bold italic underline | alignleft aligncenter alignright | bullist numlist | table | image | code',
    menubar: false,
    content_style: "body { font-family: Calibri, Arial, sans-serif; font-size: 12pt; }"
});
</script>
<script>
function abrirDireccion() {
    const direccion = document.querySelector(".direccion-accidente").innerText.trim();
    if (!direccion) {
        alert("No hay dirección disponible.");
        return;
    }
    const url = "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(direccion);
    window.open(url, "_blank");
}

function abrirCoordenadas() {
    const lat = document.querySelector(".latitud").innerText.trim();
    const lon = document.querySelector(".longitud").innerText.trim();

    if (!lat || !lon) {
        alert("No hay coordenadas disponibles.");
        return;
    }

    const url = `https://www.google.com/maps?q=${lat},${lon}`;
    window.open(url, "_blank");
}
</script>

</body>
</html>
